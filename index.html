<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Gemå®¶å±ç‰¹è®­-é«˜æ¸…ç‰ˆ</title>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --error: #e74c3c; --bg: #f4f7f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 35px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); text-align: center; width: 100%; max-width: 380px; min-height: 560px; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box; }
        .chinese-hint { font-size: 36px; color: #2c3e50; font-weight: bold; margin: 15px 0; }
        .quiz-word { font-size: 34px; letter-spacing: 4px; color: var(--primary); font-weight: bold; min-height: 50px; }
        input { font-size: 26px; padding: 15px; width: 90%; border: 3px solid #eee; border-radius: 18px; text-align: center; outline: none; transition: all 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(74,144,226,0.2); }
        input.wrong { border-color: var(--error); background: #fff5f5; animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        #choice-area { display: none; margin-top: 15px; background: #fff3e0; padding: 15px; border-radius: 20px; border: 2px dashed #ffb74d; }
        .choice-btn { background: white; border: 2px solid #ffb74d; padding: 12px; margin: 6px; border-radius: 12px; font-size: 18px; width: 85%; cursor: pointer; font-weight: 500; }
        .sentence-container { display: flex; align-items: center; background: #f0f7ff; padding: 15px; border-radius: 18px; margin: 15px 0; text-align: left; border-left: 6px solid var(--primary); }
        .btn-speak { background: var(--primary); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-size: 22px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(74,144,226,0.3); }
        .btn { padding: 18px; border: none; border-radius: 20px; cursor: pointer; font-size: 18px; font-weight: bold; color: white; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-submit { background: #34495e; width: 100%; }
        .btn-next { background: var(--success); width: 100%; display: none; }
        #progress-tag { font-size: 14px; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="progress-tag">åŠ è½½ä¸­...</div>

    <div class="card">
        <div id="front-side">
            <div style="font-size:85px; margin-bottom:10px;" id="icon-display"></div>
            <div class="chinese-hint" id="cn-display"></div>
            <p style="color:#aaa; font-size:14px;">è§‚å¯Ÿå›¾ç‰‡ï¼Œé™å¿ƒæ€è€ƒ3ç§’</p>
            <button class="btn" style="background:var(--primary); width:100%; margin-top:20px;" id="flip-btn" onclick="showBack()">ğŸ”„ å‡†å¤‡æŒ‘æˆ˜</button>
        </div>

        <div id="back-side" style="display:none">
            <div id="ipa-display" style="color:#95a5a6; font-size:20px; margin-bottom:8px;"></div>
            <div class="quiz-word" id="word-hint"></div>
            <input type="text" id="wordInput" placeholder="è¯·è¾“å…¥å•è¯" autocomplete="off">
            
            <div id="choice-area">
                <p style="margin:0 0 10px 0; color:#e67e22; font-weight:bold;">ğŸ” å¯»å®æç¤ºï¼šä»ä¸‹é¢è®¤å‡ºå®ƒ</p>
                <div id="choices-list"></div>
            </div>

            <div class="sentence-container" style="display: none;">
                <div id="sentence-box" style="flex:1; font-size:16px; color:#34495e; padding-right:10px; line-height:1.4;"></div>
                <button class="btn-speak" onclick="safeSpeak('sentence')">ğŸ”Š</button>
            </div>

            <div style="display:flex; gap:12px; margin-bottom:10px;">
                <button class="btn" style="background:#9b59b6; flex:1;" onclick="safeSpeak('word-gb')">ğŸ‡¬ğŸ‡§ è‹±éŸ³</button>
                <button class="btn" style="background:#9b59b6; flex:1;" onclick="safeSpeak('word-us')">ğŸ‡ºğŸ‡¸ ç¾éŸ³</button>
            </div>
            <button id="submit-btn" class="btn btn-submit" onclick="submitAnswer()">ç¡®è®¤æäº¤</button>
        </div>
        <button id="next-btn" class="btn btn-next" onclick="handleNext()">ğŸŒŸ å¤ªæ£’äº†ï¼ä¸‹ä¸€ä¸ª</button>
    </div>

    <script>
        // ==========================================
        // 1. ã€ä¹¦æ¶åŒº / æ•°æ®åŒºã€‘
        // ä»¥åä½ åªéœ€è¦ä¿®æ”¹æˆ–å¢åŠ ä¸‹é¢çš„å†…å®¹
        // ==========================================
        // æ ¸å¿ƒé€»è¾‘ï¼šç®—å‡ºä¸¤ä¸ªå•è¯æœ‰å‡ ä¸ªå­—æ¯ä¸åŒ
function getSimilarity(s1, s2) {
    let diff = 0, s1l = s1.toLowerCase(), s2l = s2.toLowerCase();
    let len = Math.max(s1l.length, s2l.length);
    for(let i=0; i<len; i++) { if(s1l[i] !== s2l[i]) diff++; }
    return diff;
}
        const wordLibraryRaw = [
    // --- æ ¸å¿ƒè¯æ±‡ (111ä¸ª) ---
    { en: "Talk", ip: "/tÉ”Ëk/", cn: "è°ˆè¯", icon: "ğŸ’¬", sentence: "We can talk later." },
    { en: "Meet", ip: "/miËt/", cn: "é‡è§", icon: "ğŸ¤", sentence: "Nice to meet you." },
    { en: "Sing", ip: "/sÉªÅ‹/", cn: "å”±æ­Œ", icon: "ğŸ¤", sentence: "She likes to sing." },
    { en: "Wave", ip: "/weÉªv/", cn: "æŒ¥æ‰‹", icon: "ğŸ‘‹", sentence: "Wave goodbye to dad." },
    { en: "Point", ip: "/pÉ”Éªnt/", cn: "æŒ‡", icon: "â˜ï¸", sentence: "Point to the window." },
    { en: "Listen", ip: "/ËˆlÉªsn/", cn: "å¬", icon: "ğŸ‘‚", sentence: "Listen to the music." },
    { en: "Shake", ip: "/ÊƒeÉªk/", cn: "æ‘‡æ™ƒ", icon: "ğŸ¤", sentence: "Shake hands with him." },
    { en: "Do", ip: "/duË/", cn: "åš", icon: "âœï¸", sentence: "Do your homework." },
    { en: "Look", ip: "/lÊŠk/", cn: "çœ‹", icon: "ğŸ‘€", sentence: "Look at the map." },
    { en: "Friend", ip: "/frend/", cn: "æœ‹å‹", icon: "ğŸ‘¬", sentence: "You are my best friend." },
    { en: "Name", ip: "/neÉªm/", cn: "åå­—", icon: "ğŸ·ï¸", sentence: "My name is Gem." },
    { en: "Ear", ip: "/ÉªÉ™/", cn: "è€³æœµ", icon: "ğŸ‘‚", sentence: "I have two ears." },
    { en: "Hand", ip: "/hÃ¦nd/", cn: "æ‰‹", icon: "âœ‹", sentence: "Wash your hands." },
    { en: "Mouth", ip: "/maÊŠÎ¸/", cn: "å˜´å·´", icon: "ğŸ‘„", sentence: "Open your mouth." },
    { en: "Eye", ip: "/aÉª/", cn: "çœ¼ç›", icon: "ğŸ‘ï¸", sentence: "Close your eyes." },
    { en: "Month", ip: "/mÊŒnÎ¸/", cn: "æœˆä»½", icon: "ğŸ“…", sentence: "Which month is it?" },
    { en: "Foot", ip: "/fÊŠt/", cn: "è„š", icon: "ğŸ¦¶", sentence: "The left foot." },
    { en: "Food", ip: "/fuËd/", cn: "é£Ÿç‰©", icon: "ğŸ”", sentence: "I love healthy food." },
    { en: "Arm", ip: "/É‘Ëm/", cn: "èƒ³è†Š", icon: "ğŸ’ª", sentence: "He has a strong arm." },
    { en: "Nice", ip: "/naÉªs/", cn: "å¥½çš„", icon: "âœ¨", sentence: "Have a nice day." },
    { en: "Letter", ip: "/ËˆletÉ™/", cn: "å­—æ¯/ä¿¡", icon: "âœ‰ï¸", sentence: "Write a letter." },
    { en: "Sound", ip: "/saÊŠnd/", cn: "å£°éŸ³", icon: "ğŸ”Š", sentence: "I like this sound." },
    { en: "Write", ip: "/raÉªt/", cn: "å†™", icon: "âœï¸", sentence: "Write your name." },
    { en: "Say", ip: "/seÉª/", cn: "è¯´", icon: "ğŸ—£ï¸", sentence: "Say hello to me." },
    { en: "Read", ip: "/riËd/", cn: "è¯»", icon: "ğŸ“–", sentence: "Read a book." },
    { en: "First", ip: "/fÉœËst/", cn: "ç¬¬ä¸€", icon: "ğŸ¥‡", sentence: "The first one." },
    { en: "Smile", ip: "/smaÉªl/", cn: "å¾®ç¬‘", icon: "ğŸ˜Š", sentence: "Keep smiling." },
    { en: "Small", ip: "/smÉ”Ël/", cn: "å°çš„", icon: "ğŸ­", sentence: "It is a small mouse." },
    { en: "Smell", ip: "/smel/", cn: "é—»", icon: "ğŸ‘ƒ", sentence: "Smell the flower." },
    { en: "Good", ip: "/É¡ÊŠd/", cn: "å¥½", icon: "ğŸ‘", sentence: "Good job." },
    { en: "Bad", ip: "/bÃ¦d/", cn: "å", icon: "ğŸ‘", sentence: "It's a bad habit." },
    { en: "Can", ip: "/kÃ¦n/", cn: "èƒ½", icon: "âœ…", sentence: "I can do it." },
    { en: "Too", ip: "/tuË/", cn: "ä¹Ÿ/å¤ª", icon: "â•", sentence: "Me too." },
    { en: "Two", ip: "/tuË/", cn: "äºŒ", icon: "2ï¸âƒ£", sentence: "Two apples." },
    { en: "To", ip: "/tuË/", cn: "å‘", icon: "â¡ï¸", sentence: "Go to bed." },
    { en: "Fair", ip: "/feÉ™/", cn: "å…¬å¹³", icon: "âš–ï¸", sentence: "That's not fair." },
    { en: "Air", ip: "/eÉ™/", cn: "ç©ºæ°”", icon: "ğŸŒ¬ï¸", sentence: "Fresh air." },
    { en: "Here", ip: "/hÉªÉ™/", cn: "è¿™é‡Œ", icon: "ğŸ“", sentence: "Come here." },
    { en: "There", ip: "/Ã°eÉ™/", cn: "é‚£é‡Œ", icon: "ğŸ‘‰", sentence: "Over there." },
    { en: "Have", ip: "/hÃ¦v/", cn: "æœ‰", icon: "ğŸ¤²", sentence: "I have a pen." },
    { en: "These", ip: "/Ã°iËz/", cn: "è¿™äº›", icon: "ğŸ‘", sentence: "These are mine." },
    { en: "Those", ip: "/Ã°É™ÊŠz/", cn: "é‚£äº›", icon: "ğŸ™Œ", sentence: "Those are yours." },
    { en: "Their", ip: "/Ã°eÉ™/", cn: "ä»–ä»¬çš„", icon: "ğŸ‘¥", sentence: "It is their house." },
    { en: "They", ip: "/Ã°eÉª/", cn: "ä»–ä»¬", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", sentence: "They are happy." },
    { en: "Them", ip: "/Ã°em/", cn: "ä»–ä»¬(å®¾æ ¼)", icon: "ğŸ‘¥", sentence: "I like them." },
    { en: "She", ip: "/ÊƒiË/", cn: "å¥¹", icon: "ğŸ‘§", sentence: "She is a girl." },
    { en: "Her", ip: "/hÉœË/", cn: "å¥¹çš„", icon: "ğŸ‘—", sentence: "It is her bag." },
    { en: "Its", ip: "/Éªts/", cn: "å®ƒçš„", icon: "ğŸ¾", sentence: "The dog wagged its tail." },
    { en: "His", ip: "/hÉªz/", cn: "ä»–çš„", icon: "ğŸ‘¦", sentence: "It is his ball." },
    { en: "My", ip: "/maÉª/", cn: "æˆ‘çš„", icon: "ğŸ™‹", sentence: "My book." },
    { en: "Me", ip: "/miË/", cn: "æˆ‘(å®¾æ ¼)", icon: "ğŸ™‹", sentence: "Tell me." },
    { en: "We", ip: "/wiË/", cn: "æˆ‘ä»¬", icon: "ğŸ‘ª", sentence: "We are friends." },
    { en: "Us", ip: "/ÊŒs/", cn: "æˆ‘ä»¬(å®¾æ ¼)", icon: "ğŸ‘ª", sentence: "Join us." },
    { en: "Our", ip: "/ËˆaÊŠÉ™/", cn: "æˆ‘ä»¬çš„", icon: "ğŸ˜ï¸", sentence: "Our classroom." },
    { en: "You", ip: "/juË/", cn: "ä½ ", icon: "ğŸ‘ˆ", sentence: "You are welcome." },
    { en: "Your", ip: "/jÉ”Ë/", cn: "ä½ çš„", icon: "ğŸ’", sentence: "Your bag." },
    { en: "Different", ip: "/ËˆdÉªfrÉ™nt/", cn: "ä¸åŒ", icon: "ğŸŒ“", sentence: "We are different." },
    { en: "Ask", ip: "/É‘Ësk/", cn: "é—®", icon: "â“", sentence: "Ask a question." },
    { en: "Some", ip: "/sÊŒm/", cn: "ä¸€äº›", icon: "ğŸ", sentence: "I want some milk." },
    { en: "Same", ip: "/seÉªm/", cn: "ç›¸åŒ", icon: "ğŸ‘¯", sentence: "The same color." },
    { en: "Answer", ip: "/ËˆÉ‘ËnsÉ™/", cn: "å›ç­”", icon: "ğŸ“", sentence: "Answer the phone." },
    { en: "Care", ip: "/keÉ™/", cn: "ç…§é¡¾", icon: "â¤ï¸", sentence: "Take care." },
    { en: "Each", ip: "/iËtÊƒ/", cn: "æ¯ä¸ª", icon: "â˜ï¸", sentence: "Each person." },
    { en: "Other", ip: "/ËˆÊŒÃ°É™/", cn: "å…¶ä»–", icon: "â•", sentence: "The other one." },
    { en: "Together", ip: "/tÉ™ËˆÉ¡eÃ°É™/", cn: "ä¸€èµ·", icon: "ğŸ‘«", sentence: "Let's play together." },
    { en: "Hold", ip: "/hÉ™ÊŠld/", cn: "æ‹¿/æ¡", icon: "ğŸ¤", sentence: "Hold my hand." },
    { en: "Now", ip: "/naÊŠ/", cn: "ç°åœ¨", icon: "â°", sentence: "Do it now." },
    { en: "Start", ip: "/stÉ‘Ët/", cn: "å¼€å§‹", icon: "ğŸ", sentence: "Start the game." },
    { en: "Word", ip: "/wÉœËd/", cn: "å•è¯", icon: "ğŸ”¤", sentence: "A new word." },
    { en: "Toy", ip: "/tÉ”Éª/", cn: "ç©å…·", icon: "ğŸ§¸", sentence: "My favorite toy." },
    { en: "Stop", ip: "/stÉ’p/", cn: "åœæ­¢", icon: "ğŸ›‘", sentence: "Stop here." },
    { en: "Poster", ip: "/ËˆpÉ™ÊŠstÉ™/", cn: "æµ·æŠ¥", icon: "ğŸ–¼ï¸", sentence: "A big poster." },
    { en: "Tick", ip: "/tÉªk/", cn: "æ‰“é’©", icon: "âœ…", sentence: "Tick the box." },
    { en: "Tall", ip: "/tÉ”Ël/", cn: "é«˜çš„", icon: "ğŸ¦’", sentence: "He is tall." },
    { en: "Fruit", ip: "/fruËt/", cn: "æ°´æœ", icon: "ğŸ", sentence: "Eat more fruit." },
    { en: "Live", ip: "/lÉªv/", cn: "å±…ä½", icon: "ğŸ ", sentence: "I live here." },
    { en: "Love", ip: "/lÊŒv/", cn: "çˆ±", icon: "â¤ï¸", sentence: "I love mom." },
    { en: "Member", ip: "/ËˆmembÉ™/", cn: "æˆå‘˜", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", sentence: "A family member." },
    { en: "New", ip: "/njuË/", cn: "æ–°çš„", icon: "ğŸ†•", sentence: "A new car." },
    { en: "Feel", ip: "/fiËl/", cn: "æ„Ÿè§‰", icon: "ğŸ§¸", sentence: "I feel happy." },
    { en: "Sunny", ip: "/ËˆsÊŒni/", cn: "æ™´å¤©", icon: "â˜€ï¸", sentence: "Sunny weather." },
    { en: "Rainy", ip: "/ËˆreÉªni/", cn: "ä¸‹é›¨", icon: "ğŸŒ§ï¸", sentence: "Rainy day." },
    { en: "Warm", ip: "/wÉ”Ëm/", cn: "æ¸©æš–", icon: "â™¨ï¸", sentence: "Warm water." },
    { en: "Cold", ip: "/kÉ™ÊŠld/", cn: "å†·", icon: "â„ï¸", sentence: "I feel cold." },
    { en: "Like", ip: "/laÉªk/", cn: "å–œæ¬¢", icon: "ğŸ‘", sentence: "I like cat." },
    { en: "Amazing", ip: "/É™ËˆmeÉªzÉªÅ‹/", cn: "æƒŠå–œ", icon: "ğŸ¤©", sentence: "It's amazing." },
    { en: "Fast", ip: "/fÉ‘Ëst/", cn: "å¿«", icon: "âš¡", sentence: "Run fast." },
    { en: "Slow", ip: "/slÉ™ÊŠ/", cn: "æ…¢", icon: "ğŸ¢", sentence: "Slow down." },
    { en: "Know", ip: "/nÉ™ÊŠ/", cn: "çŸ¥é“", icon: "ğŸ’¡", sentence: "I know it." },
    { en: "Animal", ip: "/ËˆÃ¦nÉªml/", cn: "åŠ¨ç‰©", icon: "ğŸ¦", sentence: "Love animals." },
    { en: "Else", ip: "/els/", cn: "å…¶ä»–", icon: "â“", sentence: "Anything else?" },
    { en: "Use", ip: "/juËz/", cn: "ä½¿ç”¨", icon: "ğŸ”¨", sentence: "Use a pen." },
    { en: "Sea", ip: "/siË/", cn: "å¤§æµ·", icon: "ğŸŒŠ", sentence: "In the sea." },
    { en: "See", ip: "/siË/", cn: "çœ‹", icon: "ğŸ‘€", sentence: "See a bird." },
    { en: "Bee", ip: "/biË/", cn: "èœœèœ‚", icon: "ğŸ", sentence: "A busy bee." },
    { en: "Make", ip: "/meÉªk/", cn: "åˆ¶ä½œ", icon: "ğŸ› ï¸", sentence: "Make a cake." },
    { en: "Touch", ip: "/tÊŒtÊƒ/", cn: "è§¦æ‘¸", icon: "ğŸ–ï¸", sentence: "Touch your nose." },
    { en: "Sit", ip: "/sÉªt/", cn: "å", icon: "ğŸª‘", sentence: "Sit down." },
    { en: "Down", ip: "/daÊŠn/", cn: "å‘ä¸‹", icon: "ğŸ‘‡", sentence: "Go down." },
    { en: "Up", ip: "/ÊŒp/", cn: "å‘ä¸Š", icon: "ğŸ‘†", sentence: "Stand up." },
    { en: "Around", ip: "/É™ËˆraÊŠnd/", cn: "å‘¨å›´", icon: "ğŸ”„", sentence: "Look around." },
    { en: "Again", ip: "/É™ËˆÉ¡en/", cn: "å†æ¬¡", icon: "ğŸ”", sentence: "Try again." },
    { en: "Many", ip: "/Ëˆmeni/", cn: "è®¸å¤š", icon: "ğŸ”¢", sentence: "Many books." },
    { en: "Shop", ip: "/ÊƒÉ’p/", cn: "å•†åº—", icon: "ğŸ›’", sentence: "Go to the shop." },
    { en: "Card", ip: "/kÉ‘Ëd/", cn: "å¡ç‰‡", icon: "ğŸƒ", sentence: "A birthday card." },
    { en: "Number", ip: "/ËˆnÊŒmbÉ™/", cn: "æ•°å­—", icon: "1ï¸âƒ£", sentence: "Phone number." },
    { en: "Chinese", ip: "/ËŒtÊƒaÉªËˆniËz/", cn: "ä¸­æ–‡", icon: "ğŸ‡¨ğŸ‡³", sentence: "Speak Chinese." },
    { en: "Spider", ip: "/ËˆspaÉªdÉ™/", cn: "èœ˜è››", icon: "ğŸ•·ï¸", sentence: "Little spider." },
    { en: "Over", ip: "/ËˆÉ™ÊŠvÉ™/", cn: "åœ¨...ä¸Š", icon: "ğŸ”", sentence: "Game over." },
    { en: "Right", ip: "/raÉªt/", cn: "å¯¹/å³", icon: "âœ…", sentence: "Turn right." },
    { en: "Wrong", ip: "/rÉ’Å‹/", cn: "é”™", icon: "âŒ", sentence: "It's wrong." },

    // --- ğŸ¦’ åŠ¨ç‰©è¡¥å…… ---
    { en: "Dog", ip: "/dÉ’É¡/", cn: "ç‹—", icon: "ğŸ¶", sentence: "A loyal dog." },
    { en: "Cat", ip: "/kÃ¦t/", cn: "çŒ«", icon: "ğŸ±", sentence: "Cute cat." },
    { en: "Duck", ip: "/dÊŒk/", cn: "é¸­å­", icon: "ğŸ¦†", sentence: "Duck swims." },
    { en: "Pig", ip: "/pÉªÉ¡/", cn: "çŒª", icon: "ğŸ·", sentence: "Pink pig." },
    { en: "Fish", ip: "/fÉªÊƒ/", cn: "é±¼", icon: "ğŸŸ", sentence: "Golden fish." },

    // --- ğŸŒ² æ¤ç‰©/è‡ªç„¶è¡¥å…… ---
    { en: "Tree", ip: "/triË/", cn: "æ ‘", icon: "ğŸŒ³", sentence: "Tall tree." },
    { en: "Grass", ip: "/É¡rÉ‘Ës/", cn: "è‰", icon: "ğŸŒ±", sentence: "Green grass." },
    { en: "Flower", ip: "/ËˆflaÊŠÉ™/", cn: "èŠ±", icon: "ğŸŒ¸", sentence: "Beautiful flower." },
    { en: "Sun", ip: "/sÊŒn/", cn: "å¤ªé˜³", icon: "â˜€ï¸", sentence: "The sun is hot." },

    // --- ğŸ« åœ°ç‚¹/ç”Ÿæ´»è¡¥å…… ---
    { en: "Home", ip: "/hÉ™ÊŠm/", cn: "å®¶", icon: "ğŸ ", sentence: "Go home." },
    { en: "Park", ip: "/pÉ‘Ëk/", cn: "å…¬å›­", icon: "â›²", sentence: "In the park." },
    { en: "Zoo", ip: "/zuË/", cn: "åŠ¨ç‰©å›­", icon: "ğŸ¦", sentence: "Visit the zoo." },
    { en: "Farm", ip: "/fÉ‘Ëm/", cn: "å†œåœº", icon: "ğŸšœ", sentence: "On the farm." }
];

// æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨åˆ†çº§ï¼ˆ3ä¸ªå­—æ¯å†…L1, 5ä¸ªå†…L2, å‰©ä¸‹L3ï¼‰
const wordLibrary = wordLibraryRaw.map(item => {
    let lv = item.en.length <= 3 ? 1 : (item.en.length <= 5 ? 2 : 3);
    return { ...item, level: lv };
});

        // ==========================================
        // 2. ã€ä¸»ç¨‹åº / é€»è¾‘åŒºã€‘
        // è¿™é‡Œçš„ä»£ç å¤„ç†å‘éŸ³ã€æ£€æµ‹ã€å¯»å®é€»è¾‘ï¼Œè½»æ˜“ä¸è¦åŠ¨
        // ==========================================
        let wordProgress = JSON.parse(localStorage.getItem('gem_final_pro_v3')) || {};
        wordLibrary.forEach(w => { if(!wordProgress[w.en]) wordProgress[w.en] = { level: 0 }; });

        let currentPool = [...wordLibrary], wrongWords = [], index = 0, hasLooked = false;

        function safeSpeak(type) {
            window.speechSynthesis.cancel(); 
            setTimeout(() => {
                const item = currentPool[index];
                const text = type === 'sentence' ? item.sentence : item.en;
                const msg = new SpeechSynthesisUtterance(text);
                msg.rate = type === 'sentence' ? 0.45 : 0.7; // æ…¢é€Ÿé«˜æ¸…
                msg.pitch = 1.0;
                msg.volume = 1.0;
                if(type === 'word-gb') msg.lang = 'en-GB';
                else msg.lang = 'en-US';
                window.speechSynthesis.speak(msg);
            }, 50);
        }

        function showBack() {
            document.getElementById('front-side').style.display = 'none';
            document.getElementById('back-side').style.display = 'block';
            document.getElementById('wordInput').focus();
        }

        function submitAnswer() {
            const input = document.getElementById('wordInput');
            const userVal = input.value.toLowerCase().trim();
            const correctVal = currentPool[index].en.toLowerCase();
            if (userVal === correctVal) {
                input.classList.remove('wrong');
                document.getElementById('submit-btn').style.display = 'none';
                document.getElementById('next-btn').style.display = 'block';
                document.getElementById('choice-area').style.display = 'none';
                document.querySelector('.sentence-container').style.display = 'flex';
                safeSpeak('word-gb');
            } else {
                input.classList.add('wrong');
                showChoices();
                hasLooked = true;
            }
        }

        function showChoices() {
            const area = document.getElementById('choice-area');
            const list = document.getElementById('choices-list');
            area.style.display = 'block';
            list.innerHTML = "";
                        const currentEn = currentPool[index].en;
            let choices = [currentEn];

            // ğŸš€ å¯»æ‰¾æœ€åƒçš„â€œå¹²æ‰°é¡¹â€ï¼ˆå¯¹æ¯”è®°å¿†é€»è¾‘ï¼‰
            let similarityMap = wordLibrary
                .filter(w => w.en !== currentEn)
                .map(w => ({ word: w.en, diff: getSimilarity(currentEn, w.en) }))
                .sort((a, b) => a.diff - b.diff);

            // ä¼˜å…ˆæŠŠé•¿å¾—æœ€åƒçš„é‚£ä¸ªè¯å¡è¿›é€‰é¡¹
            if(similarityMap.length > 0) choices.push(similarityMap[0].word);
            while(choices.length < 3) {
                let r = wordLibrary[Math.floor(Math.random()*wordLibrary.length)].en;
                if(!choices.includes(r)) choices.push(r);
            }
            choices.sort(() => Math.random() - 0.5);
            choices.forEach(c => {
                let btn = document.createElement('button');
                btn.className = "choice-btn";
                btn.innerText = c;
                btn.onclick = () => {
                    document.getElementById('wordInput').value = "";
                    document.getElementById('wordInput').focus();
                };
                list.appendChild(btn);
            });
        }

        function handleNext() {
            const currentWord = currentPool[index].en;
            if (hasLooked) {
                if (!wrongWords.find(w => w.en === currentWord)) wrongWords.push(currentPool[index]);
            }
            index++;
            if (index >= currentPool.length) {
                if (wrongWords.length > 0) {
                    currentPool = [...wrongWords]; wrongWords = []; index = 0;
                    alert("è¿›å…¥å¼ºåŒ–å¤ä¹ æ¨¡å¼ï¼");
                } else {
                    alert("ğŸ‰ å¤ªæ£’äº†ï¼ä»»åŠ¡å®Œæˆï¼");
                    location.reload(); return;
                }
            }
            render();
        }

        function render() {
            const item = currentPool[index];
            hasLooked = false;
            document.querySelector('.sentence-container').style.display = 'none';
            document.getElementById('progress-tag').innerText = `ç¬¬ ${index + 1} ä¸ªï¼Œå…± ${currentPool.length} ä¸ª`;
            document.getElementById('icon-display').innerText = item.icon;
            document.getElementById('cn-display').innerText = item.cn;
            document.getElementById('ipa-display').innerText = item.ip || "";
            document.getElementById('sentence-box').innerText = item.sentence;
            document.getElementById('word-hint').innerText = item.en[0] + " _ ".repeat(item.en.length - 2) + item.en.slice(-1);
            document.getElementById('wordInput').value = "";
            document.getElementById('wordInput').classList.remove('wrong');
            document.getElementById('choice-area').style.display = 'none';
            document.getElementById('front-side').style.display = 'block';
            document.getElementById('back-side').style.display = 'none';
            document.getElementById('submit-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
            
            const flipBtn = document.getElementById('flip-btn');
            flipBtn.disabled = true;
            let sec = 3;
            const timer = setInterval(() => {
                sec--;
                if(sec <= 0) {
                    flipBtn.innerText = "ğŸ”„ å‡†å¤‡æŒ‘æˆ˜";
                    flipBtn.disabled = false;
                    clearInterval(timer);
                } else {
                    flipBtn.innerText = `æ€è€ƒä¸­ (${sec}s)`;
                }
            }, 1000);
        }

        window.onload = render;
    </script>
</body>
</html>
